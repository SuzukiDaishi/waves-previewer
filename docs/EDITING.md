# 編集機能 仕様（提案）

本仕様は waves-previewer に編集機能を追加する際の方針・UI・処理・書き出しに関する指針です。現状は WAV/モノラル前提ですが、将来の多チャンネル対応を見据えます。

**目的**
- 素早い試聴の流れを壊さず、必要な軽量編集（トリム/ゲイン/フェード/伸縮/ピッチ）を一息で完了できる。
- 既存のアーキテクチャ（ロックレス再生、非同期処理、タブUI）に整合。

**範囲**
- 入力: WAV（PCM 16/24/32f を想定）。内部は 32bit float モノラル処理。
- 出力: WAV（PCM 16/24/32f）。ビット深度変換時は TPDF ディザ（将来）。
- 将来: 多形式（mp3/ogg/flac/aac）は読み取りのみ→編集は WAV 書き出しで対応開始。

## 編集モデル
- 非破壊（既定）: エディタタブでパラメータを保持し、プレビュー用バッファを生成。保存時に適用して新規ファイルを書き出し。
- 破壊（オプション）: 明示的に「上書き保存」を選択時のみ元ファイルを置換（.bak 退避＋アトミック置換）。
- オペレーションスタック: 
  - 操作は順序付きで保持（Gain → Fade → Stretch → Pitch など）。
  - Undo/Redo: コマンド履歴（最大件数/メモリ上限）を設け、重い処理はパラメータ差分のみ保持して再計算（必要時にバックグラウンド再生成）。

## サポートする操作（MVP → 拡張）
- 基本
  - トリム: 選択範囲で切り出し／選択以外を削除。
  - ゲイン: dB 入力（-60..+24）、ピーク/クリップ警告。
  - ノーマライズ: ピーク基準（例: -1.0 dBFS）、将来 RMS/LUFS 対応検討。
  - フェード: IN/OUT（ms/秒指定、カーブ: 線形/対数）。
  - 反転（Reverse）: 選択範囲/全体。
  - 無音挿入/削除: 選択位置に ms で挿入／選択を無音化。
- タイム/ピッチ（signalsmith-stretch）
  - TimeStretch: 0.25..4.0（ピッチ保持）。
  - PitchShift: -12..+12 st（時間長保持）。
  - 品質: `preset_default` を既定、将来 `preset_cheaper` を選択可能に。
  - シームレス再生/書出し: 出力レイテンシと `flush()` を考慮し、末尾欠けを防止。必要に応じてループ用に開始位置オフセットを自動調整。
- 変換
  - サンプルレート変換（線形/将来 HQ SRC）。
  - ビット深度変換（16/24/32f）。
  - DC オフセット除去（将来）。

## 精度/内部処理
- 内部: 32-bit float モノラル。
- 入出力: 読み込みは元形式→float へ正規化、書き出し時に選択のフォーマットへ変換。クリップはオプション（ハードリミット/ソフト制限は将来）。
- 長尺最適化: 数十分級はチャンク（ブロック）処理＋ストリーミング書き出しを採用（MVP は全体展開で開始）。

## UI/UX
- エディタタブ
  - 選択ツール: クリック/ドラッグで範囲選択、Shift で拡張、ダブルクリックで全選択。
  - インスペクタ: 操作パネル（Gain dB、Normalize 目標、Fade、Time/Pitch、SR/BitDepth）。
  - ループマーカー: A/B 設定、シームレスループ確認（プレイヘッド連続）。
  - スナップ: ゼロクロス/タイムグリッド。
- 処理体験
  - 軽量操作（Gain/Fade/Trim）は即時反映。
  - 重い操作（Time/Pitch/SR 変換）は非同期ジョブ化。全画面カバー＋スピナー、進捗（%）とキャンセル。
  - パラメータ連続変更はデバウンス（例: 200ms）し、直近のみ実行。

## 非同期ジョブ（共通基盤）
- キュー: 先頭 1 件（最新優先・古い保留ジョブをキャンセル）／将来は優先度制御。
- スレッド: `std::thread` + `mpsc`、将来 Rayon/スレッドプール化。
- メッセージ: Start/Progress/Finish/Cancel/Fail。
- UI: 前景レイヤで入力ブロック、完了でバッファと波形を差し替え、必要ならループ範囲を再設定。

## 保存/書き出し
- 操作
  - Export As…: 名前規則 `name__op1-op2-...__YYYYMMDD-HHMM.wav`。出力 SR/BitDepth を設定可能。既定は入力 SR/BitDepth を保持。
  - Overwrite: `.bak` へ退避後にアトミック置換。失敗時は復旧。
  - Export Selection: 選択範囲のみ書き出し（ループ区間や A–B 指定にも対応）。
- 実装
  - 一時ファイル（同一ディレクトリ）→`fs::rename` でアトミック置換（Windows のロック状況に注意）。
  - WAV 書き出しは `hound`。メタ情報は将来 `LIST/INFO`（必要に応じてコピー）。
  - 長尺はストリーミング書き出し（チャンク処理）を検討。

## ループと継ぎ目
- 再生: 出力レイテンシ + `flush()` を考慮して末尾欠けなし。必要に応じて `loop_start` をオフセットし継ぎ目の段差を抑制（ゼロクロスにスナップ）。
- 書出し: 「シームレスループ書出し」オプションで、先頭/末尾を最小限クロスフェードして継ぎ目の位相段差を緩和（将来）。

## 例外/エラー
- 書き出し失敗: 一時ファイル削除、UI 通知、ログ出力。
- 破壊的編集: パーミッション/ロックエラーの検知と復旧、バックアップ必須。

## テレメトリ/ログ（任意）
- 失敗理由や処理時間を DEBUG ログで計測（ユーザに送信しない、ローカルのみ）。

## 段階的実装計画（MVP → 拡張）
1. 非同期ジョブ共通基盤（進捗/キャンセル）＋UI オーバーレイの進捗表示
2. トリム/ゲイン/ノーマライズ/フェードの実装と Export As…
3. TimeStretch/PitchShift の選択範囲適用・書出し対応（signalsmith-stretch 流用）、末尾欠け・レイテンシ処理統合
4. ループマーカー+A–B 書出し、ゼロクロススナップ
5. SR/BitDepth 変換、dither（TPDF）、ストリーミング書出し
6. Undo/Redo、ジョブキュー高度化、長尺最適化
---

# 編集UI（階層化）追補

本アプリの編集は「View → Tool」の階層で操作します。ビューを切り替えると、ツールとインスペクタが自動的に入れ替わります。再生/ループ/A–B/時間軸はすべてのビューで共有されます。

- View: Waveform / Spectrogram / Mel / WORLD（段階的に追加）
- Tool（例）
  - Waveform: Loop Edit, Trim, Fade, Gain, Normalize, Reverse, Silence, Pitch, Stretch
  - Spectrogram: 矩形選択、Noise Reduce（初期）、Attenuate/Repair（拡張）
  - Mel: 初期は閲覧のみ
  - WORLD: F0/包絡編集（将来）
- ショートカット（案）: 1=Wave, 2=Spec, 3=Mel, 4=World / Q=Seek, W=Loop, E=Trim, R=Fade, T=Gain, Y=NoiseReduce, Esc=Cancel


# UI/UX デザイン仕様（提案）

このドキュメントは、waves-previewer（WavesViewer）の画面設計と振る舞いをまとめたものです。

画像モックは以下を参照してください。
- リスト: docs/要件定義_リスト.png
- 波形エディタ: docs/要件定義_波形エディタ.png

## 目標
- 大量の SFX/VO/BGM を、DAW を起動せずに素早く試聴・比較できる。
- 読み込み・表示・操作が軽快であること。
- 将来的な編集・解析機能（ズーム/パン/AB ループ等）を追加しやすい土台。

## デザイン原則（シック、実用、軽量）

- 配色: ダーク基調 + 控えめな寒色アクセント（視認性と疲労軽減）。
- 一貫性: 余白、行高、境界線の太さを統一し、タブ・テーブルで水平整列。
- コントラスト: 背景と波形の十分なコントラスト、グリッドは弱め。
- タイポグラフィ: 日本語フォントを OS から動的読み込み（Meiryo/Yu Gothic/MSGothic）。
- パフォーマンス: 描画は事前計算（min/max）、UI は 60fps 目安で再描画要求。

## 画面構成

- 共通（上部バー）
  - フォルダ選択（再帰走査）
  - 音量スライダ（dB: -80〜+6）
  - dBFS メータ（RMS 簡易）
  - 再生ボタン（Space でトグル）
  - 小幅時は横並びから折り返して2段表示（`horizontal_wrapped`）。

- リスト画面（既定）
  - 列: File | Folder | Length | Ch | SR | Bits | Level(dBFS) | Gain(dB) | Wave
    - 全列でリサイズ可能、長いテキストは自動切り詰め（...）＋ホバーで全文表示
    - Length 列は時間（mm:ss）表示、ソート時は秒数で比較
  - 行クリック: 選択＋音声ロード（Space ですぐ再生可）
  - ファイル名ダブルクリック: 「波形エディタ」タブを開く（既に開いていればアクティブ化）
  - フォルダ名ダブルクリック: OS のファイルブラウザでそのWAVを選択状態で開く
  - キーバインド: ↑/↓ 行移動、Enter でタブを開く、Space で再生
  - **再生方式**: リスト表示時は常にループ再生が無効（一度再生で停止）

- 波形エディタ（タブ）
  - フル波形（min/max）と水平グリッド
  - 垂直プレイヘッド（再生位置）
  - クリックでプレイヘッド移動、クリック&ドラッグでスクラブ、Space で再生/停止
  - Ctrl + ホイールでズーム、Shift + ホイール（または横ホイール）で左右パン
  - ループ再生のトグル（全体ループ・ギャップ無し）。将来は範囲選択でループ範囲指定。
  - **再生方式**: エディタ表示時のみループ再生の有効/無効を切り替え可能
  - 将来: ホイールでズーム、ドラッグでパン、範囲選択、A–B ループ

## タブ vs 別ウィンドウ

- 採用: まずは「タブ（同一ウィンドウ内）」を既定とする。
  - 理由: 実装コストが低く、状態管理が単純、ショートカットの作用範囲が明確。
- 追加予定: タブの「ポップアウト」（別ウィンドウ化）
  - 利点: マルチモニタで並べられる。複数エディタを同時に可視化。
  - 注意: マルチウィンドウ管理・フォーカス・ショートカットの衝突に配慮が必要。

## 状態とデータフロー

- `AudioEngine`（既存）：
  - `ArcSwapOption<Vec<f32>>` に再生バッファ、`Atomic` 群に音量・再生状態・再生位置・RMS を保持し、CPAL コールバックで消費。
- `AppState`（GUI）：
  - 現在のルートフォルダ、走査結果（メタ＋サムネ）、開いているタブとアクティブタブ ID。
  - タブは（パス、表示設定、ズーム/パン、選択範囲 など）を保持。

## 実装ステップ（ロードマップ短期）

1. 既存の「左リスト＋中央波形」から「リスト画面」単独レイアウトへ整理。
2. タブコンテナを導入し、クリックでエディタタブを開くフローを実装。
3. エディタタブに現在の波形描画を移設（プレイヘッド描画を追加）。
4. リスト行にサムネ・音量(dB) 概算を表示（非同期生成）。
5. キーバインド（↑/↓/Enter/Space）の統合。
6. 将来: タブのポップアウト（別ウィンドウ）。

## 非目標（当面）
- 破壊的編集（書き込み保存）
- 複雑なエフェクトチェーンや解析（将来別モジュールで検討）

## 技術メモ
- タブ UI: `egui` の `TabBar` / `Ui::horizontal_wrapped` 等で構築、もしくは簡易タブを自作。
- マルチウィンドウ: `egui` のマルチビューポート（対応状況に依存）に段階的対応。
- サムネ生成: バックグラウンドで min/max（128bins）を計算してキャッシュ。UI は受信次第リフレッシュ。
- リストの描画は `TableBody::rows` で仮想化し、可視範囲のみ描画。
